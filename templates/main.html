<!DOCTYPE html>
<html>
<head>
    <title>メイン - 片付けアプリ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='js/character.js') }}"></script>
    <script>
        // メニューの表示・非表示を切り替える関数
        function toggleMenu() {
            const menuItems = document.getElementById('menu-items');
            const menuButton = document.querySelector('.menu-button');
            const menuIcon = document.querySelector('.menu-icon');
            
            if (menuItems && menuButton && menuIcon) {
                const isVisible = menuItems.classList.contains('visible');
                
                if (isVisible) {
                    menuItems.classList.remove('visible');
                    menuButton.classList.remove('active');
                    // 元の画像に戻す
                    menuIcon.src = "{{ url_for('static', filename='images/menu_hako.png') }}";
                } else {
                    menuItems.classList.add('visible');
                    menuButton.classList.add('active');
                    // 空の画像に変更
                    menuIcon.src = "{{ url_for('static', filename='images/menu_hako_empty.png') }}";
                }
            }
        }

        // ページ読み込み完了後に初期化
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('menu-toggle');
            const menuItems = document.getElementById('menu-items');
            
            // 初期状態でメニューを非表示にする
            if (menuItems) {
                menuItems.classList.remove('visible');
            }
            
            // メニューボタンにイベントリスナーを追加
            if (menuButton) {
                menuButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMenu();
                });
            }
            
            // メニュー外をクリックしたときにメニューを閉じる
            document.addEventListener('click', function(e) {
                const menuIcon = document.querySelector('.menu-icon');
                if (menuItems && menuButton && menuIcon &&
                    !menuButton.contains(e.target) && 
                    !menuItems.contains(e.target)) {
                    menuItems.classList.remove('visible');
                    menuButton.classList.remove('active');
                    // 元の画像に戻す
                    menuIcon.src = "{{ url_for('static', filename='images/menu_hako.png') }}";
                }
            });
            
            // 背景画像をTODO完了状態に応じて更新
            updateBackground();
        });
        
        // 背景画像を更新する関数
        async function updateBackground() {
            try {
                const response = await fetch('/check_todos_status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const backgroundImage = document.querySelector('.background-image');
                        if (backgroundImage) {
                            const newSrc = "{{ url_for('static', filename='images/') }}" + data.background;
                            backgroundImage.src = newSrc;
                        }
                    }
                }
            } catch (error) {
                console.error('背景更新エラー:', error);
            }
        }
    </script>
</head>
<body class="main-page">
    <div class="main-container">
        <!-- タイトル -->
        <div class="title-container">
            <h1 class="app-title">KATADUKE</h1>
        </div>
        <!-- 背景レイヤー -->
        <div class="background-layer">
            <img src="{{ url_for('static', filename='images/mainback_dirty.png') }}" alt="背景" class="background-image">
        </div>
        
        <!-- フレームレイヤー -->
        <div class="frame-layer">
            <img src="{{ url_for('static', filename='images/frame.png') }}" alt="フレーム" class="frame-image">
        </div>

        <!-- キャラクターエリア -->
        <div class="character-area">
            <div id="character">
                <img src="{{ url_for('static', filename='images/char_front.png') }}" alt="キャラクター" style="max-width: 300px;">
            </div>
            <div id="speech-bubble">
                <p>片付けを始めましょう！</p>
            </div>
        </div>

        <!-- メニューボタン -->
        <div class="menu-container">
            <button class="menu-button" id="menu-toggle">
                <img src="{{ url_for('static', filename='images/menu_hako.png') }}" alt="メニュー" class="menu-icon">
            </button>

            <!-- メニューアイテム -->
            <div id="menu-items" class="menu-items">
                <a href="{{ url_for('camera') }}" class="menu-item">
                    <span class="menu-label">カメラ</span>
                    <img src="{{ url_for('static', filename='images/camera_icon.png') }}" alt="カメラ">
                </a>
                <a href="{{ url_for('todo') }}" class="menu-item">
                    <span class="menu-label">TODO</span>
                    <img src="{{ url_for('static', filename='images/todo_icon.png') }}" alt="TODO">
                </a>
                <a href="{{ url_for('album') }}" class="menu-item">
                    <span class="menu-label">アルバム</span>
                    <img src="{{ url_for('static', filename='images/album_icon.png') }}" alt="アルバム">
                </a>
                <a href="{{ url_for('tips') }}" class="menu-item">
                    <span class="menu-label">TIPS</span>
                    <img src="{{ url_for('static', filename='images/tips_icon.png') }}" alt="TIPS">
                </a>
            </div>
        </div>

        <!-- ログアウトボタン -->
        <a href="{{ url_for('logout') }}" class="logout-button">ログアウト</a>
    </div>
</body>
</html>